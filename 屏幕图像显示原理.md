# 屏幕图像显示原理

> 关键词：像素、位图/纹理、GPU、合成、OpenGL


## 一、基本概念
### 1. 驱动程序

驱动程序是添加到操作系统中的一小块代码，其中包含有关硬件设备的信息。有了此信息，计算机就可以与设备进行通信。对于装有显卡的计算机来说，没有显卡驱动，就不能识别GPU硬件，不能调用其计算资源。

驱动程序是硬件的一部分，当你安装新硬件时，驱动程序是一项不可或缺的重要元件。凡是安装一个原本不属于你电脑中的硬件设备时，系统就会要求你安装驱动程序，将新的硬件与电脑系统连接起来。**驱动程序扮演沟通的角色，把硬件的功能告诉电脑系统，并且也将系统的指令传达给硬件，让它开始工作。**

参考：   
- [驱动 - 百度百科](https://baike.baidu.com/item/%E9%A9%B1%E5%8A%A8/2765136)
- [显卡、显卡驱动、cuda 之间的关系是什么？](https://www.zhihu.com/question/59184480)

### 2. 显卡

#### 2.1 什么是显卡
显卡（Video card，Graphics card）全称显示接口卡，又称显示适配器，是计算机最基本配置、最重要的配件之一。显卡作为电脑主机里的一个重要组成部分，是电脑进行数模信号转换的设备，承担输出显示图形的任务。显卡接在电脑主板上，它将电脑的数字信号转换成模拟信号让显示器显示出来，同时显卡还是有图像处理能力，可协助CPU工作，提高整体的运行速度。

#### 2.2 显卡的工作原理

数据（data）一旦离开CPU，必须通过4个步骤，最后才会到达显示屏：

1．从总线（Bus）进入GPU（Graphics Processing Unit，图形处理器）：将CPU送来的数据送到北桥（主桥）再送到GPU（图形处理器）里面进行处理。           
2．从 Video Chipset（显卡芯片组）进入 Video RAM（显存）：将芯片处理完的数据送到显存。           
3．从显存进入Digital Analog Converter （= RAM DAC，随机读写存储数—模转换器）：从显存读取出数据再送到RAM DAC进行数据转换的工作（数字信号转模拟信号）。但是如果是DVI接口类型的显卡，则不需要经过数字信号转模拟信号。而直接输出数字信号。           
4．从DAC进入显示器（Monitor）：将转换完的模拟信号送到显示屏。  
         
显示效能是系统效能的一部分，其效能的高低由以上四步所决定，它与显卡的效能（Video Performance）不太一样，如要严格区分，显卡的效能应该受中间两步所决定，因为这两步的资料传输都是在显卡的内部。第一步是由CPU 进入到显卡里面，最后一步是由显卡直接送资料到显示屏上。   


#### 2.3 显卡的构成

显卡通常由总线接口、PCB板、显示芯片、显存、RAMDAC、VGA BIOS、VGA功能插针、D-sub插座及其他外围组件构成，现在的显卡大多还具有VGA、DVI显示器接口或者HDMI接口及S-Video端子和Display Port接口。      

显示芯片：Video chipset，也叫GPU或VPU，图形处理器或视觉处理器，是显卡的主要处理单元 。 
显存：显存全称显示存储器，亦称帧缓存，它是用来存储显示芯片处理过或者即将读取的渲染数据。如同计算机的内存一样，显存是用来存储图形数据的硬件。

参考：   
- [显卡 - 百度百科](https://baike.baidu.com/item/%E6%98%BE%E5%8D%A1)
- [显卡 - 维基百科](https://zh.wikipedia.org/wiki/%E6%98%BE%E7%A4%BA%E5%8D%A1)
- [显存 - 维基百科](https://zh.wikipedia.org/wiki/%E6%98%BE%E5%AD%98)

### 3. GPU

#### 3.1 什么是 GPU ？
图形处理器（英语：Graphics Processing Unit，缩写：GPU），又称显示核心、视觉处理器、显示芯片，是一种专门在个人电脑、工作站、游戏机和一些移动设备（如平板电脑、智能手机等）上**图像运算**工作的微处理器。

#### 3.2 GPU 的作用
显卡的处理器称为图形处理器（GPU），它是显卡的“心脏”，与CPU类似，只不过GPU是**专为执行复杂的数学和几何计算而设计的**，这些计算是图形渲染所必需的。某些最快速的GPU集成的晶体管数甚至超过了普通CPU。

如果CPU想画一个二维图形，只需要发个指令给GPU，如“在坐标位置（x, y）处画个长和宽为a×b大小的长方形”，GPU就可以迅速计算出该图形的所有像素，并在显示器上指定位置画出相应的图形，画完后就通知CPU “我画完了”，然后等待CPU发出下一条图形指令。


有了GPU，CPU就从图形处理的任务中解放出来，可以执行其他更多的系统任务，这样可以大大提高计算机的整体性能。

参考：     
- [图形处理器 - 百度百科](https://baike.baidu.com/item/%E5%9B%BE%E5%BD%A2%E5%A4%84%E7%90%86%E5%99%A8/8694767?fromtitle=gpu&fromid=105524)

#### 3.3 GPU 和 CPU 的区别？


参考：      
- [CPU 和 GPU 的区别是什么？](https://www.zhihu.com/question/19903344)

#### 3.4 GPU 的工作原理


参考：      
- [CPU 和 GPU 的区别是什么？](https://www.zhihu.com/question/19903344)

#### 3.5 GPU 和显卡的关系

GPU 是显卡的主要处理单元。GPU是显示卡的“大脑”，GPU决定了该显卡的档次和大部分性能，同时GPU也是2D显示卡和3D显示卡的区别依据。

GPU 使显卡减少了对中央处理器的依赖，并分担了部分原本是由中央处理器所担当的工作，尤其是在进行三维绘图运算时，功效更加明显。

参考：     
- [GPU 和显卡是什么关系？](https://www.zhihu.com/question/28422454)
- [图形处理器 - 维基百科](https://zh.wikipedia.org/wiki/%E5%9C%96%E5%BD%A2%E8%99%95%E7%90%86%E5%99%A8)


## 二、图像显示原理


图像显示的最基本的单元——像素。

![](https://www.objccn.io/images/issues/issue-3/pixels-software-stack.png)

屏幕图像的显示依赖于 GPU 合成的位图/纹理，软件层通过 GPU Driver 跟 GPU 硬件打交道。OpenGL(Open Graphics Library) 提供了 2D 和 3D 图形渲染的 API，自从 OpenGL 的出现，程序员不再需要为每个GPU重写他们的应用了。基于 OpenGL，Apple 通过 Core Animation、Core Graphics 和 Core Image 等框架实现了更高层次的图像绘制功能。


### 1. 合成纹理
在图形世界中，合成是一个描述不同位图如何放到一起来创建你最终在屏幕上看到图像的过程。

让我们先暂时忽略一些复杂的细节，并且假定屏幕上一切皆纹理。一个纹理就是一个包含 RGBA 值的长方形，比如，每一个像素里面都包含红、绿、蓝和透明度的值。在 Core Animation 世界中这就相当于一个 CALayer。

在这个简化的设置中，每一个 layer 是一个纹理，所有的纹理都以某种方式堆叠在彼此的顶部。对于屏幕上的每一个像素，GPU 需要算出怎么混合这些纹理来得到像素 RGB 的值。这就是合成大概的意思。

### 2. 透明 VS 不透明
- 当源纹理是完全不透明的时候，目标像素就等于源纹理。这可以省下 GPU 很大的工作量，这样只需简单的拷贝源纹理而不需要合成所有的像素值。

- CALayer 有一个叫做 opaque 的属性了。如果这个属性为 YES，GPU 将不会做任何合成，而是简单从这个层拷贝，不需要考虑它下方的任何东西(因为都被它遮挡住了)。这节省了 GPU 相当大的工作量。这也正是 Instruments 中 color blended layers 选项中所涉及的。
 
- 如果你知道你的 layer 是不透明的，最好确定设置它的 opaque 为 YES。如果你加载一个没有 alpha 通道的图片，并且将它显示在 UIImageView 上，这将会自动发生。

### 3. 像素对齐


在iOS中，有一个概念叫做像素对齐，如果像素不对齐，那么在GPU渲染时，需要进行插值计算，这个插值计算的过程会有性能损耗。

主要有两个原因可能会造成不对齐。第一个便是缩放；当一个纹理放大缩小的时候，纹理的像素便不会和屏幕的像素排列对齐。另一个原因便是当纹理的起点不在一个像素的边界上。

在这两种情况下，GPU 需要再做额外的计算。它需要将源纹理上多个像素混合起来，生成一个用来合成的值。当所有的像素都是对齐的时候，GPU 只剩下很少的工作要做。

在 iPhone 模拟器和 Instruments 上，有一个 color misaligned images 选项可以把像素不对齐的部分显示出来。

延伸阅读：

- [iOS优化：解决iOS中像素不对齐问题](https://www.jianshu.com/p/432fea0232b8)
- [iOS开发之图片分辨率与像素对齐](https://www.cnblogs.com/huahuahu/p/iOS-kai-fa-zhi-tu-pian-fen-bian-lu-yu-xiang-su-dui.html)



## 参考

- [绘制像素到屏幕上 - objc.io](https://www.objccn.io/issue-3-1/)